<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>InsertAfter : Toward a stricter query string parser</title>
  <meta name="description" content="With most query string parsers, a lot of URIs can point to the same
 content. It not only mess you cache system but make your logs less expressive.
 To avoid those problems I just wrote a stricter query string parser.">
  <link rel="bookmark" href="https://insertafter.com/en/blog/toward_stricter_query_string_parser.html" />
  <link rel="icon" type="image/png" href="/images/favicon.png" />
  <meta name="robots" content="index,follow">
  <link rel="stylesheet" href="/css/main.css">
  <link href='https://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
  
</head>
<body class="ia-standalone">
  <!--[if lt IE 7]>
  <script>document.location.href=http://browsehappy.com;</script>
  <![endif]-->
  <header class="ia-header">
    <div class="ia-header__title">
      <h1><a href="/en/index.html" title="Back to home"
        class="ia-logo">
        <img src="/images/logo.svg" alt="Logo Insert After" />
      </a></h1>
    </div>
  </header>
  <nav class="ia-languages">
    <a class="ia-flag ia-flag--fr" href="/fr/index.html"
      title="Retour à l&#39;accueil">
      <span>Accueil</span>
    </a>
    <a class="ia-flag ia-flag--en" href="/en/index.html"
      title="Back to home"
      class="selected">
      <span>Home</span>
    </a>
  </nav>

  <nav class="ia-menu">
    <ul class="ia-menu__body">
      <li class="ia-menu__item ia-menu__item--index">
        <a href="/en/index.html"
          title="Back to home">Home</a>
      </li>
      <li class="ia-menu__item ia-menu__item--index">
        <a href="/en/blog/index.html"
          title="Back to home"
          class="selected">Blog</a>
      </li>
      <li class="ia-menu__item ia-menu__item--projects">
        <a href="/en/projects.html"
          title="Learn more about my projects">Projects</a>
      </li>
      <li class="ia-menu__item ia-menu__item--about">
        <a href="/en/about.html"
          title="Learn more about me">About</a>
      </li>
    </ul>
  </nav>

  <section class="ia-main ia-content">
    <div>
    
<article class="ia-main__content">
  

<h2>Toward a stricter query string parser</h2>
<p>
  <strong>
    TL.DR. Having a stricter query string policy adds value to APIs. Checkout
    <a href="https://github.com/nfroidure/strict-qs">strict-qs</a>.
  </strong>
</p>
<p>
  I my journey to the NodeJS HTTP server of my choice, I just reached a new
  milestone. Indeed, in the ancient ages, when PHP was my language of choice, i
  made a simple framework called <a href="https://github.com/Rest4">Rest4</a>.
</p>
<p>
  One of its features was to strictly check for query params types, order and
  existence. I felt a bit unpowered when I figured out that most NodeJS
  frameworks follow a non restrictive path when it comes to parse query strings.
</p>
<p>
  When no checks are done on query strings, you can end up with a lot of URIs
  pointing to the same resource. By example, in most applications the following
  URIs would serve the same resource:<br />
  <code>/articles?q=test</code>,<br />
  <code>/articles?q=test&amp;page=1</code>,<br />
  <code>/articles?page=1&amp;q=test</code>,<br />
  <code>/articles?q=test&amp;page=invalid</code>,<br />
  <code>/articles?q=test&amp;page</code>,<br />
  <code>/articles?q=test&amp;page=1&amp;dummy=lol</code>.<br />
  This has a lot of undesired effects.
</p>
<h3>Content duplication</h3>
<p>
  If you are serving webpages you may want to avoid being downgraded in
  <a href="https://support.google.com/webmasters/answer/66359?hl=en"
    >search engines</a
  >. There are other ways to prevent this but with a strict query string policy
  it comes out of the box.
</p>
<h3>Harder caching</h3>
<p>
  If you want to use the resource URI as a key in a Redis cache to speed up your
  API, you won't be able to use the URI as is, without being vulnerable to cache
  flooding.
</p>
<p>
  You'll first have to create a canonical URI to store your contents and this
  extra compute will be done every time you will access your cache. Also public
  proxies often have their own interpretation of HTTP caching specs, providing
  unique URIs ensure you a better handling of your HTTP requests by them.
</p>
<h3>Messy logs</h3>
<p>
  Logs get harder to reduce/compare/read until you reorder query strings
  yourself before logging. Even if you do that, your upstream tools (say NGinX,
  HAProxy, Fastly...) won't take advantage of it.
</p>
<h3>Defensive programming</h3>
<p>
  Consider the following URI:<br />
  <code>/articles?q=test&amp;page=1&amp;page=1&amp;page=1&amp;page=1</code
  >.<br />
  With a simple query parser, it will lead to an array of pages which is
  probably not what you want. It leads to unexpected behavior and lots of
  attacks are based on it.
</p>
<p>
  Just created <a href="https://github.com/nfroidure/strict-qs">strict-qs</a> to
  match those issues. It simply builds an object whose properties are query
  parameters of the types you would expect. If you try it, let me know ;).
</p>
<p>
  You'll still have to validate it with a JSONSchema validator since I wanted it
  to do one thing and do it well. There is plenty of JSONSchema validators, I
  currently use <a href="https://github.com/epoberezkin/ajv">AJV</a>.
</p>
<p>
  Finally, there is still some work to achieve in order to ensure unicity of
  paths too. The following URIs would also lead to the same resource:<br />
  <code>/articles/1</code>, <code>/articles/0001</code>,
  <code>/articles/1/</code> I updated
  <a href="https://github.com/nfroidure/siso">siso</a> to handle this problem
  too.
</p>

</article>
<nav class="ia-main__back">
  <a href="/en/blog/index.html"
    title="Nicolas Froidure&#39;s Blog, Fullstack JavaScript Developper">
    &lt; Blog
  </a>
</nav>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES * * */
      var disqus_shortname = 'insertafter';
      var disqus_config = function () {
        this.language = "en";
        this.callbacks.onNewComment = [function() {
          ga('send', 'event', 'interaction', 'comment');
        }];
      };

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
    </div>
  </section>

  <aside class="ia-icons ia-content">
    <nav>
      <a href="https://twitter.com/nfroidure" title="Follow me on Twitter"
        class="ia-social ia-social--twitter">
        <span>Twitter</span>
      </a>
      <a href="https://github.com/nfroidure" title="Follow me on GitHub"
        class="ia-social ia-social--github">
        <span>GitHub</span>
      </a>
      <a href="https://www.npmjs.org/~nfroidure" title="Find NPM modules"
        class="ia-social ia-social--npm">
        <span>NPM</span>
      </a>
      <a href="https://www.linkedin.com/in/nfroidure" title="Find me on LinkedIn"
        class="ia-social ia-social--linkedin">
        <span>LinkedIn</span>
      </a>
      <a href="/en/blog/index.atom" title="Don't miss my blog posts"
        class="ia-social ia-social--feed">
        <span>ATOM feed</span>
      </a>
    </nav>
  </aside>

  <footer class="ia-footer">
    <p class="ia-footer__content">
      © Nicolas Froidure 2012-2021
    </p>
  </footer>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-21477946-7', 'insertafter.com');
    ga('send', 'pageview');

  </script>
</body>
</html>
